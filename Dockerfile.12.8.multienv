# ä½¿ç”¨ NVIDIA å®˜æ–¹ CUDA 12.8 é•œåƒ
# å¤š Conda ç¯å¢ƒç‰ˆæœ¬ï¼šæ”¯æŒä¸åŒæ¨¡å‹ä½¿ç”¨ä¸åŒçš„ä¾èµ–ç‰ˆæœ¬
FROM nvidia/cuda:12.8.0-devel-ubuntu22.04

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8
ENV TZ=Asia/Shanghai
ENV PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
ENV DEBIAN_FRONTEND=noninteractive

# è®¾ç½®æ—¶åŒº
RUN ln -sf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# æ›¿æ¢ä¸ºé˜¿é‡Œäº‘ Ubuntu é•œåƒæºï¼ˆåŠ é€Ÿä¸‹è½½ï¼‰
RUN sed -i 's|archive.ubuntu.com|mirrors.aliyun.com|g' /etc/apt/sources.list && \
    sed -i 's|security.ubuntu.com|mirrors.aliyun.com|g' /etc/apt/sources.list || true

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆä¸åŒ…æ‹¬ Pythonï¼Œä½¿ç”¨ conda å®‰è£…ï¼‰
# libgl1 ç”¨äº paddleocr/opencvï¼ˆåœ¨ Ubuntu 22.04+ ä¸­ï¼Œlibgl1-mesa-glx å·²è¢«æ›¿æ¢ä¸º libgl1ï¼‰
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    git \
    libnuma-dev \
    zlib1g-dev \
    wget \
    ca-certificates \
    bzip2 \
    libgl1 \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# ä¸‹è½½å¹¶å®‰è£… Miniconda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh && \
    bash /tmp/miniconda.sh -b -p /opt/conda && \
    rm /tmp/miniconda.sh

# å…ˆæ¥å—æœåŠ¡æ¡æ¬¾
RUN /opt/conda/bin/conda tos accept

# åˆ›å»ºå¤šä¸ª conda ç¯å¢ƒ
# lcagent-core: æ ‡å‡†ç¯å¢ƒï¼Œä½¿ç”¨ transformers==4.57.3ï¼ˆç”¨äº vllm ç­‰ï¼‰
# lcagent-lmdeploy: lmdeploy ä¸“ç”¨ç¯å¢ƒï¼Œä½¿ç”¨ transformers==4.47.1ï¼ˆç”¨äº deepseek-vl2 ç­‰ï¼‰
RUN /opt/conda/bin/conda create -n lcagent-core python=3.10 -y && \
    /opt/conda/bin/conda create -n lcagent-lmdeploy python=3.10 -y && \
    /opt/conda/bin/conda clean --all -f -y

# è®¾ç½®é»˜è®¤ä½¿ç”¨ lcagent-core conda ç¯å¢ƒ
ENV CONDA_DEFAULT_ENV=lcagent-core
ENV CONDA_PREFIX=/opt/conda/envs/lcagent-core
ENV PATH=/opt/conda/envs/lcagent-core/bin:/opt/conda/bin:$PATH

# åœ¨ä¸¤ä¸ª conda ç¯å¢ƒä¸­å‡çº§ pip
RUN /opt/conda/envs/lcagent-core/bin/pip install --no-cache-dir --upgrade pip setuptools wheel && \
    /opt/conda/envs/lcagent-lmdeploy/bin/pip install --no-cache-dir --upgrade pip setuptools wheel

# CUDA ç¯å¢ƒå˜é‡ï¼ˆNVIDIA é•œåƒå·²è‡ªåŠ¨è®¾ç½®ï¼Œæ˜¾å¼è®¾ç½®ä»¥ç¡®ä¿æ­£ç¡®ï¼‰
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}

# è®¾ç½®ç¼–è¯‘é€‰é¡¹ï¼ˆç”¨äº flash-attnï¼‰
ENV TORCH_CUDA_ARCH_LIST="8.0;9.0"
ENV MAX_JOBS=1
# å¢åŠ ç¼–è¯‘è¶…æ—¶å’Œä¼˜åŒ–é€‰é¡¹
ENV FLASH_ATTENTION_SKIP_CUDA_BUILD=0
ENV FLASH_ATTENTION_FORCE_BUILD=0

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶æºç 
COPY . /app/

# ============================================================================
# å®‰è£… lcagent-core ç¯å¢ƒä¾èµ–ï¼ˆæ ‡å‡†ç¯å¢ƒï¼Œtransformers==4.57.3ï¼‰
# ============================================================================
# è¯´æ˜ï¼šå°† flash-attn åˆ†ç¦»åˆ°å•ç‹¬çš„ RUN å±‚ï¼Œé¿å…ç¼–è¯‘è¶…æ—¶å½±å“æ•´ä¸ªæ„å»º
RUN set -x && \
    echo "ğŸ“¦ å®‰è£… lcagent-core ç¯å¢ƒä¾èµ–ï¼ˆæ ‡å‡†ç¯å¢ƒï¼‰..." && \
    grep -v "^flash-attn" requirements.full.txt | /opt/conda/envs/lcagent-core/bin/pip install --no-cache-dir -r /dev/stdin && \
    /opt/conda/envs/lcagent-core/bin/pip install --no-cache-dir -e . && \
    /opt/conda/envs/lcagent-core/bin/pip cache purge

# å•ç‹¬å®‰è£… flash-attnï¼ˆåˆ†ç¦»å±‚ï¼Œé¿å…ç¼–è¯‘è¶…æ—¶å½±å“å…¶ä»–ä¾èµ–ï¼‰
# ä¼˜å…ˆå°è¯•ä½¿ç”¨é¢„ç¼–è¯‘ wheelï¼ˆé¿å…é•¿æ—¶é—´ç¼–è¯‘ï¼‰ï¼Œå¦‚æœä¸å¯ç”¨åˆ™ç¼–è¯‘å®‰è£…
RUN set -x && \
    echo "ğŸ” å°è¯•åœ¨ lcagent-core ç¯å¢ƒä¸­å®‰è£… flash-attnï¼ˆä¼˜å…ˆä½¿ç”¨é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼‰..." && \
    if /opt/conda/envs/lcagent-core/bin/pip install --no-cache-dir flash-attn --only-binary :all: 2>&1; then \
        echo "âœ… flash-attn å®‰è£…æˆåŠŸï¼ˆä½¿ç”¨é¢„ç¼–è¯‘ wheelï¼‰" && \
        /opt/conda/envs/lcagent-core/bin/pip show flash-attn | head -5; \
    else \
        echo "âš ï¸ é¢„ç¼–è¯‘ wheel ä¸å¯ç”¨ï¼Œå¼€å§‹ç¼–è¯‘å®‰è£…ï¼ˆå¯èƒ½éœ€è¦ 10-30 åˆ†é’Ÿï¼‰..." && \
        if /opt/conda/envs/lcagent-core/bin/pip install --no-cache-dir --no-build-isolation flash-attn 2>&1; then \
            echo "âœ… flash-attn ç¼–è¯‘å®‰è£…æˆåŠŸ" && \
            /opt/conda/envs/lcagent-core/bin/pip show flash-attn | head -5; \
        else \
            echo "âŒ flash-attn å®‰è£…å¤±è´¥ï¼Œè·³è¿‡ï¼ˆå¦‚æœä¸éœ€è¦å¯ä»¥å¿½ç•¥ï¼‰" && \
            true; \
        fi; \
    fi

# ============================================================================
# å®‰è£… lcagent-lmdeploy ç¯å¢ƒä¾èµ–ï¼ˆlmdeploy ä¸“ç”¨ç¯å¢ƒï¼Œtransformers==4.47.1ï¼‰
# ============================================================================
# è¯´æ˜ï¼šæ­¤ç¯å¢ƒä¸“é—¨ç”¨äºéœ€è¦ transformers < 4.48.0 çš„æ¨¡å‹ï¼ˆå¦‚ deepseek-vl2ï¼‰
# åªå®‰è£…å¿…è¦çš„ä¾èµ–ï¼Œé¿å…é‡å¤å®‰è£…
RUN set -x && \
    echo "ğŸ“¦ å®‰è£… lcagent-lmdeploy ç¯å¢ƒä¾èµ–ï¼ˆlmdeploy ä¸“ç”¨ç¯å¢ƒï¼‰..." && \
    echo "   ä½¿ç”¨ transformers==4.47.1ï¼ˆå…¼å®¹ lmdeploy 0.11.0 çš„ deepseek-vl2ï¼‰" && \
    # å…ˆå®‰è£…åŸºç¡€ä¾èµ–ï¼ˆä» requirements.full.txt ä¸­æå–ï¼Œä½†æ’é™¤ transformersï¼‰
    grep -v "^flash-attn" requirements.full.txt | grep -v "^transformers" | \
    /opt/conda/envs/lcagent-lmdeploy/bin/pip install --no-cache-dir -r /dev/stdin && \
    # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ transformersï¼ˆå…¼å®¹ lmdeployï¼‰
    /opt/conda/envs/lcagent-lmdeploy/bin/pip install --no-cache-dir transformers==4.47.1 && \
    # ç¡®ä¿ lmdeploy å·²å®‰è£…
    /opt/conda/envs/lcagent-lmdeploy/bin/pip install --no-cache-dir lmdeploy==0.11.0 && \
    # å®‰è£… lazyllm åŒ…
    /opt/conda/envs/lcagent-lmdeploy/bin/pip install --no-cache-dir -e . && \
    /opt/conda/envs/lcagent-lmdeploy/bin/pip cache purge

# éªŒè¯ä¸¤ä¸ªç¯å¢ƒçš„ transformers ç‰ˆæœ¬
RUN set -x && \
    echo "ğŸ” éªŒè¯ conda ç¯å¢ƒé…ç½®..." && \
    echo "lcagent-core ç¯å¢ƒ transformers ç‰ˆæœ¬:" && \
    /opt/conda/envs/lcagent-core/bin/pip show transformers | grep Version || echo "æœªå®‰è£…" && \
    echo "lcagent-lmdeploy ç¯å¢ƒ transformers ç‰ˆæœ¬:" && \
    /opt/conda/envs/lcagent-lmdeploy/bin/pip show transformers | grep Version || echo "æœªå®‰è£…" && \
    echo "âœ… å¤šç¯å¢ƒé…ç½®å®Œæˆ"

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV LAZYLLM_DEFAULT_LAUNCHER=empty

# æš´éœ²ç«¯å£
EXPOSE 31340 31341

# é»˜è®¤å‘½ä»¤ï¼ˆå¯ä»¥åœ¨ docker-compose.yml ä¸­è¦†ç›–ï¼‰
CMD ["/bin/bash"]

