# 使用 NVIDIA 官方 CUDA 12.8 镜像
# 多 Conda 环境版本：支持不同模型使用不同的依赖版本
FROM nvidia/cuda:12.8.0-devel-ubuntu22.04

# 设置环境变量
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8
ENV TZ=Asia/Shanghai
ENV PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
ENV DEBIAN_FRONTEND=noninteractive

# 设置时区
RUN ln -sf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 替换为阿里云 Ubuntu 镜像源（加速下载）
RUN sed -i 's|archive.ubuntu.com|mirrors.aliyun.com|g' /etc/apt/sources.list && \
    sed -i 's|security.ubuntu.com|mirrors.aliyun.com|g' /etc/apt/sources.list || true

# 安装系统依赖（不包括 Python，使用 conda 安装）
# libgl1 用于 paddleocr/opencv（在 Ubuntu 22.04+ 中，libgl1-mesa-glx 已被替换为 libgl1）
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    git \
    libnuma-dev \
    zlib1g-dev \
    wget \
    ca-certificates \
    bzip2 \
    libgl1 \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 下载并安装 Miniconda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh && \
    bash /tmp/miniconda.sh -b -p /opt/conda && \
    rm /tmp/miniconda.sh

# 先接受服务条款
RUN /opt/conda/bin/conda tos accept

# 创建多个 conda 环境
# lcagent-core: 标准环境，使用 transformers==4.57.3（用于 vllm 等）
# lcagent-lmdeploy: lmdeploy 专用环境，使用 transformers==4.47.1（用于 deepseek-vl2 等）
RUN /opt/conda/bin/conda create -n lcagent-core python=3.10 -y && \
    /opt/conda/bin/conda create -n lcagent-lmdeploy python=3.10 -y && \
    /opt/conda/bin/conda clean --all -f -y

# 设置默认使用 lcagent-core conda 环境
ENV CONDA_DEFAULT_ENV=lcagent-core
ENV CONDA_PREFIX=/opt/conda/envs/lcagent-core
ENV PATH=/opt/conda/envs/lcagent-core/bin:/opt/conda/bin:$PATH

# 在两个 conda 环境中升级 pip
RUN /opt/conda/envs/lcagent-core/bin/pip install --no-cache-dir --upgrade pip setuptools wheel && \
    /opt/conda/envs/lcagent-lmdeploy/bin/pip install --no-cache-dir --upgrade pip setuptools wheel

# CUDA 环境变量（NVIDIA 镜像已自动设置，显式设置以确保正确）
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}

# 设置工作目录
WORKDIR /app

# 复制源码
COPY . /app/

# 安装环境依赖， flash-attn后续通过wheel手动安装 https://github.com/Dao-AILab/flash-attention/releases
RUN set -x && \
    grep -v "^flash-attn" requirements.full.txt | /opt/conda/envs/lcagent-core/bin/pip install --no-cache-dir -r /dev/stdin && \
    /opt/conda/envs/lcagent-core/bin/pip install --no-cache-dir -e . && \
    /opt/conda/envs/lcagent-core/bin/pip cache purge

RUN set -x && \
    grep -v "^flash-attn" requirements.full.txt | grep -v "^transformers" | \
    /opt/conda/envs/lcagent-lmdeploy/bin/pip install --no-cache-dir -r /dev/stdin && \
    /opt/conda/envs/lcagent-lmdeploy/bin/pip install --no-cache-dir transformers==4.47.1 && \
    /opt/conda/envs/lcagent-lmdeploy/bin/pip install --no-cache-dir lmdeploy==0.11.0 && \
    /opt/conda/envs/lcagent-lmdeploy/bin/pip install --no-cache-dir -e . && \
    /opt/conda/envs/lcagent-lmdeploy/bin/pip cache purge

# 设置环境变量
ENV PYTHONPATH=/app
ENV LAZYLLM_DEFAULT_LAUNCHER=empty

# 暴露端口
EXPOSE 31340 31341

# 默认命令（可以在 docker-compose.yml 中覆盖）
CMD ["/bin/bash"]

